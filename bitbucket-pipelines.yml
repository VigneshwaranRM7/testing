image: node:18

pipelines:
  branches:
    master:  # Runs when a PR is merged into master
      - step:
          name: Setup SSH Connection
          script:
            - echo "ðŸ”‘ Setting up SSH..."
            - mkdir -p ~/.ssh
            - chmod 700 ~/.ssh
            - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
            - chmod 600 ~/.ssh/id_rsa
            - ssh-keyscan bitbucket.org >> ~/.ssh/known_hosts
            - ssh-keyscan $LIGHTSAIL_IP_MASTER >> ~/.ssh/known_hosts
            - echo "âœ… SSH setup complete."

      - step:
          name: Deploy to Production (Master)
          script:
            - echo "ðŸš€ Deploying master branch to AWS Lightsail..."
            - |
              ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no bitnami@$LIGHTSAIL_IP_MASTER << 'EOF'
              
              set -euxo pipefail
              
              echo "ðŸ” Switching to deployment directory..."
              cd /home/bitnami/rfc-api
              
              echo "ðŸ“¥ Fetching latest changes..."
              git fetch origin
              git checkout master
              git pull origin master
              echo "âœ… Code updated!"

              echo "ðŸ“¦ Installing dependencies..."
              npm install
              echo "âœ… Dependencies installed."

              echo "ðŸš€ Restarting application with PM2..."
              pm2 restart rfc-gr
              echo "âœ… Application restarted!"

              echo "ðŸŽ‰ Deployment complete!"
              EOF

    staging:  # Runs when a PR is merged into staging
      - step:
          name: Setup SSH Connection
          script:
            - echo "ðŸ”‘ Setting up SSH..."
            - mkdir -p ~/.ssh
            - chmod 700 ~/.ssh
            - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
            - chmod 600 ~/.ssh/id_rsa
            - ssh-keyscan bitbucket.org >> ~/.ssh/known_hosts
            - ssh-keyscan $LIGHTSAIL_IP_STAGING >> ~/.ssh/known_hosts
            - echo "âœ… SSH setup complete."

      - step:
          name: Deploy to Staging
          script:
            - echo "ðŸš€ Deploying staging branch to AWS Lightsail..."
            - |
              ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no bitnami@$LIGHTSAIL_IP_STAGING << 'EOF'
              
              set -euxo pipefail
              
              echo "ðŸ” Switching to deployment directory..."
              cd /home/bitnami/rfc-api
              
              echo "ðŸ“¥ Fetching latest changes..."
              git fetch origin
              git checkout staging
              git pull origin staging
              echo "âœ… Code updated!"

              echo "ðŸ“¦ Installing dependencies..."
              npm install
              echo "âœ… Dependencies installed."

              echo "ðŸš€ Restarting application with PM2..."
              pm2 restart rfc-staging
              echo "âœ… Application restarted!"

              echo "ðŸŽ‰ Deployment complete!"
              EOF